{% extends 'ticker/ticker.html' %}

{% block title %}Portfolio{% endblock %}

{% block body %}

{% with url='portfolio.frequency', params=dict() %}
{% include 'snippets/menu.html' %}
{% endwith %}

<script type="text/javascript">
  let setup = {
    minimumFractionDigits: 0,
    maximumFractionDigits: 2,
    style: 'currency',
    currency: 'USD',
  };
  const price_formatter = new Intl.NumberFormat('en-US', setup);
</script>

<script type="text/javascript">
  function render_transactions(data) {
    let $table = $('#table_transactions');
    $table.find("tbody tr").remove();
    $.each(data.results, function () {
      $table.append(
          "<tr>" +
          "<td>" + this.coin_token + "</td>" +
          "<td style=\"text-align: right;\">" + this.units + "</td>" +
          "<td style=\"text-align: right;\">" + price_formatter.format(this.amount) + "</td>" +
          "<td style=\"text-align: right;\">" + price_formatter.format(1000) + "</td>" +
          "<td style=\"text-align: center;\">" + this.in_or_out + "</td>" +
          "<td>" + this.added_on + "</td>" +
          "</tr>"
      );
    });
  }
</script>

<script type="text/javascript">
  let data_portf;
  function render_portfolio(data) {
    data_portf = data;
    let $table = $('#table_portfolio');
    $table.find("tbody tr").remove();
    for (const [key, value] of Object.entries(data)) {
      $table.append(
          "<tr>" +
          "<td>" + key + "USDT</td>" +
          "<td>" + value.exchange +"</td>" +
          "<td style=\"text-align: right;\"><span id=\"" + value.exchange.toLowerCase() + "_" + key.toLowerCase() + "usdt_price_{{frequency}}\">-</span></td>" +
          "<td style=\"text-align: right;\">" + value.total_units + "</td>" +
          "<td style=\"text-align: right;\">" + price_formatter.format(value.total_amount) + "</td>" +
          "<td style=\"text-align: right;\">" + price_formatter.format(value.average_paid) +"</td>" +
          "<td style=\"text-align: right;\"><span id=\"" + value.exchange.toLowerCase() + "_" + key.toLowerCase() + "usdt_position_{{frequency}}\">-</span></td>" +
          "</tr>"
      );
    }
  }
</script>

<script type="text/javascript">
  function get_percent(x, y) {
    if (x >= y) {
      return (100 - ((y * 100) / x)).toFixed(2)
    }
    return -(100 - ((x * 100) / y)).toFixed(2)
  }
</script>

<script type="text/javascript">
  function post_ticker_emit(id, json) {
    let symbol = data_portf[json.ticker];
    if (symbol === undefined) {
      return;
    }

    let _id = id.replace("_price_", "_position_")

    let perc = get_percent(json.price, symbol.average_paid);

    if (perc !== 0) {
      $(_id).css("color", (perc > 0) ? "green" : "red")
    } else {
      $(_id).attr("class", "numeric_value");
    }

    $(_id).text(perc + '%');
  }
</script>

<script type="text/javascript">
  $(document).ready(function() {
    get_transactions(render_transactions);
    get_portfolio(render_portfolio);
  });
</script>

<br/><br/>

<div class="row">
    <div class="five columns">
      <div style="float: left">
        <h5>My Transactions</h5>
      </div>
      <div style="float: right">
        <input class="button-primary" type="button" value="Add Tx" onClick="(
          function() {
            open_modal('#transaction');
            return false;
          })(); return false;">
      </div>

      <table class="u-full-width" id="table_transactions">
        <thead>
          <tr>
            <th>Coin/Token</th>
            <th>Units</th>
            <th>Paid</th>
            <th>Unit Price</th>
            <th>Type</th>
            <th>Added on</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>

  </div>

  <div class="seven columns">
      <div style="float: left">
        <h5>My Portfolio</h5>
      </div>
      <div style="float: right">
        <input class="button-primary" type="button" value="Reset" onClick="(
        function() {
            alert('Reset!');
            return false;
        })(); return false;">
      </div>

      <table class="u-full-width" id="table_portfolio">
        <thead>
          <tr>
            <th>Pair</th>
            <th>Exchange</th>
            <th>Price</th>
            <th>Total Units</th>
            <th>Total Paid</th>
            <th>Unit Avg Paid</th>
            <th>Position</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>

    </div>
</div>

{% include 'modals/transaction.html' %}

{% endblock %}