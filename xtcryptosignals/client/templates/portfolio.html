{% extends 'ticker/ticker.html' %}

{% block title %}Portfolio{% endblock %}

{% block body %}

{% with url='portfolio.frequency', params=dict() %}
{% include 'snippets/menu.html' %}
{% endwith %}

<link rel="stylesheet" href="/static/css/portfolio.css" type="text/css">

<script type="text/javascript">
  let setup = {
    minimumFractionDigits: 0,
    maximumFractionDigits: 2,
    style: 'currency',
    currency: 'USD',
  };
  const price_formatter = new Intl.NumberFormat('en-US', setup);
</script>

<script type="text/javascript">
  function render_transactions(data) {
    let $table = $('#table_transactions');
    $table.find("tbody tr").remove();
    $.each(data.results, function () {
      $table.append(
          "<tr>" +
          "<td>" + this.coin_token + "</td>" +
          "<td class='align-right'>" + this.units + "</td>" +
          "<td class='align-right'>" + price_formatter.format(this.amount) + "</td>" +
          "<td class='align-right'>" + price_formatter.format(this.unit_price) + "</td>" +
          "<td style=\"text-align: center;\">" + this.in_or_out + "</td>" +
          "<td>" + this.added_on + "</td>" +
          "</tr>"
      );
    });
  }
</script>

<script type="text/javascript">
  let data_portf;
  function render_portfolio(data) {
    data_portf = data;
    let $table = $('#table_portfolio');
    $table.find("tbody tr").remove();
    for (const [key, value] of Object.entries(data_portf.coin_tokens)) {
      let prefix_id = value.exchange.name + "_" + key.toLowerCase() + value.exchange.pair.toLowerCase();
      let sufix_id = 'price';
      if (value.exchange.pair === 'ETH') {
        sufix_id = 'price_usdt';
      }
      $table.append(
          "<tr>" +
          "<td>" + key + value.exchange.pair + "</td>" +
          "<td>" + value.exchange.name.toUpperCase() +"</td>" +
          "<td class='align-right pf-current-price'><span id=\"" + prefix_id + "_" + sufix_id + "_{{frequency}}\">-</span></td>" +
          "<td class='align-right pf-units'>" + value.total_units + "</td>" +
          "<td class='align-right pf-total-paid'>" + price_formatter.format(value.total_amount) + "</td>" +
          "<td class='align-right'>" + price_formatter.format(value.average_paid) +"</td>" +
          "<td class='align-right'><span id=\"" + prefix_id + "_balance_{{frequency}}\">-</span></td>" +
          "<td class='align-right'><span id=\"" + prefix_id + "_position_{{frequency}}\">-</span></td>" +
          "</tr>"
      );
    }
  }
</script>

<script type="text/javascript">
  function get_percent(x, y) {
    if (x >= y) {
      return (100 - ((y * 100) / x)).toFixed(2)
    }
    return -(100 - ((x * 100) / y)).toFixed(2)
  }
</script>

<script type="text/javascript">
  function set_style(id, perc) {
    if (perc !== 0) {
      $(id).css("color", (perc > 0) ? "green" : "red")
    } else {
      $(id).attr("class", "numeric_value");
    }
  }

  function _set_total_value_and_position(total_spent) {
    let units_list = [];
    $(".pf-units").each(function() {
        let value = $(this).text().replace(',', '');
        if(!isNaN(value) && value.length !== 0) {
          units_list.push(value);
        }
    });
    let current_price_list = [];
    $(".pf-current-price").each(function() {
        let value = $(this).text().replace(',', '');
        if(!isNaN(value) && value.length !== 0) {
          current_price_list.push(value);
        }
    });
    if (units_list.length !== current_price_list.length) {
      return
    }
    const x = Array(units_list.length).fill().map(
      (_, i) => current_price_list[i] * units_list[i]
    );
    const total_value = x.reduce((a, b) => a + b, 0);
    // total position
    let perc = get_percent(total_value, total_spent);
    let _id = '#my_portfolio_position';
    set_style(_id, perc);
    $(_id).text(perc + '%');
    // total value
    $('#my_portfolio_total_value').text(price_formatter.format(total_value));

    return total_value
  }

  const _prefix_non_eth = '_price_';
  const _prefix_eth = '_price_usdt_';

  function _set_position_and_balance_per_row_and_total_spent(
    id, json, symbol, total_spent, total_value
  ) {
    let price = json.price;
    let p = _prefix_non_eth;
    if(symbol.exchange.pair === 'ETH') {
      price = json.price_usdt;
      p = _prefix_eth;
    }
    // position
    let _id = id.replace(p, "_position_");
    let perc = get_percent(price, symbol.average_paid);
    set_style(_id, perc);
    $(_id).text(perc + '%');
    // balance
    if(!isNaN(total_value) && total_value.length !== 0) {
      _id = id.replace(p, "_balance_");
      let diff = total_value - total_spent;
      set_style(_id, diff);
      $(_id).text(price_formatter.format(diff));
    }
    // spent
    $('#my_portfolio_total_spent').text(price_formatter.format(total_spent));
  }

  function post_ticker_emit(id, json) {
    const symbol = data_portf.coin_tokens[json.ticker];
    const total_spent = data_portf.total_paid;
    if (symbol === undefined) {
      return;
    }
    if(symbol.exchange.name !== json.source) {
      return;
    }
    if(symbol.exchange.pair !== json.symbol.substr(json.ticker.length)) {
      return;
    }
    if(symbol.exchange.pair === 'ETH' && !id.includes(_prefix_eth)) {
      return;
    }
    const total_value = _set_total_value_and_position(total_spent);
    _set_position_and_balance_per_row_and_total_spent(
      id, json, symbol, total_spent, total_value
    );
  }
</script>

<script type="text/javascript">
  $(document).ready(function() {
    get_transactions(render_transactions);
    get_portfolio(render_portfolio);
  });
</script>

<br/><br/>

<div class="row">
    <div class="five columns">
      <div style="float: left">
        <h5>My Transactions</h5>
      </div>
      <div style="float: right">
        <input class="button-primary" type="button" value="Add Tx" onClick="(
          function() {
            open_modal('#transaction');
            return false;
          })(); return false;">
      </div>

      <table class="u-full-width" id="table_transactions">
        <thead>
          <tr>
            <th>Coin</th>
            <th>Units</th>
            <th>Paid</th>
            <th>Unit Price</th>
            <th>Type</th>
            <th>Added on</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>

  </div>

  <div class="seven columns">
    <div style="float: left;">
      <h5>My Portfolio</h5>
    </div>
    <div style="float: right; width: 75%">
      <div class="row example-grid docs-example">
        <div class="four columns">Paid: <span id='my_portfolio_total_spent' class="bigger">-</span></div>
        <div class="four columns">Value: <span id='my_portfolio_total_value' class="bigger">-</span></div>
        <div class="four columns">Position: <span id='my_portfolio_position' class="bigger">-</span></div>
      </div>
    </div>

    <table class="u-full-width" id="table_portfolio">
      <thead>
        <tr>
          <th>Pair</th>
          <th>Exchange</th>
          <th>Ticker</th>
          <th>Total Units</th>
          <th>Paid</th>
          <th>Paid Unit</th>
          <th>Balance</th>
          <th>Position</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>

    </div>
</div>

{% include 'modals/transaction.html' %}

{% endblock %}